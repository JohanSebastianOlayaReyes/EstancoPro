import{Ca as c,Ha as h,d as u,j as o,m as a,p as n,xa as l}from"./chunk-AOLGXRAL.js";var p=class s{constructor(e,r){this.http=e;this.router=r;let t=this.getUserFromStorage();this.currentUserSubject=new u(t),this.currentUser$=this.currentUserSubject.asObservable()}API_URL=`${h.apiUrl}/Auth`;currentUserSubject;currentUser$;get currentUserValue(){return this.currentUserSubject.value}get isAuthenticated(){let e=this.currentUserValue;return e?new Date(e.expiresAt)>new Date:!1}login(e){return this.http.post(`${this.API_URL}/login`,e).pipe(o(r=>{let t={userId:r.userId,email:r.email,roleName:r.roleName,token:r.token,refreshToken:r.refreshToken,expiresAt:new Date(r.expiresAt)};this.saveUserToStorage(t),this.currentUserSubject.next(t)}))}logout(){let e=this.currentUserValue;if(e){let r={token:e.token,refreshToken:e.refreshToken};this.http.post(`${this.API_URL}/logout`,r).subscribe()}this.clearUserFromStorage(),this.currentUserSubject.next(null),this.router.navigate(["/auth/login"])}refreshToken(){let e=this.currentUserValue;if(!e)throw new Error("No user logged in");let r={token:e.token,refreshToken:e.refreshToken};return this.http.post(`${this.API_URL}/refresh`,r).pipe(o(t=>{let i={userId:t.userId,email:t.email,roleName:t.roleName,token:t.token,refreshToken:t.refreshToken,expiresAt:new Date(t.expiresAt)};this.saveUserToStorage(i),this.currentUserSubject.next(i)}))}validateToken(){return this.http.get(`${this.API_URL}/validate`)}saveUserToStorage(e){localStorage.setItem("currentUser",JSON.stringify(e))}getUserFromStorage(){let e=localStorage.getItem("currentUser");if(!e)return null;try{let r=JSON.parse(e);return new Date(r.expiresAt)<=new Date?(this.clearUserFromStorage(),null):r}catch{return null}}clearUserFromStorage(){localStorage.removeItem("currentUser")}getAuthToken(){let e=this.currentUserValue;return e?e.token:null}hasRole(e){return this.currentUserValue?.roleName===e}hasAnyRole(e){let r=this.currentUserValue;return r?e.includes(r.roleName):!1}static \u0275fac=function(r){return new(r||s)(n(l),n(c))};static \u0275prov=a({token:s,factory:s.\u0275fac,providedIn:"root"})};export{p as a};
