import{a as U}from"./chunk-DB27QKO2.js";import{a as R}from"./chunk-VKTQXDN4.js";import{a as F}from"./chunk-RLNHWRDG.js";import{a as A}from"./chunk-U6BUASLA.js";import{b as H,d as q,f as D,k as Q,l as W,m as $,p as z}from"./chunk-VMEROYEQ.js";import{a as G}from"./chunk-M6GDLID5.js";import{$ as T,B as o,Ca as N,F as x,G as I,K as b,O as c,P as t,Q as r,R as u,S as k,T as p,U as S,X as E,Y as a,Z as P,_ as m,aa as w,ba as C,ca as M,ia as h,ja as g,qa as j,r as y,ra as O,s as _,sa as V,t as v,u as f,ua as B,va as L}from"./chunk-AOLGXRAL.js";function K(d,e){if(d&1&&(t(0,"div",53),a(1),h(2,"number"),r()),d&2){let i=S();o(),m(" Caja Abierta: $",g(2,1,i.currentSession.openingAmount,"1.0-0")," ")}}function X(d,e){d&1&&(t(0,"div",54),a(1," Sin Caja Abierta "),r())}function Y(d,e){d&1&&(t(0,"div",55),u(1,"div",56),r())}function Z(d,e){d&1&&(t(0,"div",57),v(),t(1,"svg",58),u(2,"path",59),r(),f(),t(3,"p",60),a(4,"No se encontraron productos"),r()())}function ee(d,e){if(d&1){let i=k();t(0,"div",61),p("click",function(){let l=y(i).$implicit,s=S();return _(s.addProductToSale(l))}),t(1,"div",62),v(),t(2,"svg",63),u(3,"path",64),r()(),f(),t(4,"h3",65),a(5),r(),t(6,"p",66),a(7),r(),t(8,"div",67)(9,"span",68),a(10),h(11,"number"),r(),t(12,"span",69),a(13),r()()()}if(d&2){let i=e.$implicit;E("opacity-50",i.stockQuantity<=0)("cursor-not-allowed",i.stockQuantity<=0),o(5),P(i.name),o(2),P(i.categoryName),o(3),m("$",g(11,9,i.salePrice,"1.0-0")),o(2),c("ngClass",i.stockQuantity>10?"bg-success/10 text-success":i.stockQuantity>0?"bg-warning/10 text-warning":"bg-error/10 text-error"),o(),m(" Stock: ",i.stockQuantity," ")}}function te(d,e){d&1&&(t(0,"div",57),v(),t(1,"svg",58),u(2,"path",70),r(),f(),t(3,"p",71),a(4,"El carrito est\xE1 vac\xEDo"),r()())}function ie(d,e){if(d&1){let i=k();t(0,"div",72)(1,"div",73)(2,"div",74)(3,"h4",75),a(4),r(),t(5,"p",76),a(6),h(7,"number"),r()(),t(8,"button",77),p("click",function(){let l=y(i).$implicit,s=S();return _(s.removeFromSale(l))}),v(),t(9,"svg",78),u(10,"path",79),r()()(),f(),t(11,"div",80)(12,"div",81)(13,"button",82),p("click",function(){let l=y(i).$implicit,s=S();return _(s.decreaseQuantity(l))}),v(),t(14,"svg",83),u(15,"path",84),r()(),f(),t(16,"span",85),a(17),r(),t(18,"button",86),p("click",function(){let l=y(i).$implicit,s=S();return _(s.increaseQuantity(l))}),v(),t(19,"svg",83),u(20,"path",87),r()()(),f(),t(21,"div",88)(22,"p",89),a(23),h(24,"number"),r()()()()}if(d&2){let i=e.$implicit;o(4),P(i.productName),o(2),m("$",g(7,4,i.unitPrice,"1.0-0")," c/u"),o(11),P(i.quantity),o(6),m("$",g(24,7,i.subtotal,"1.0-0"))}}function ne(d,e){if(d&1&&(t(0,"option",44),a(1),r()),d&2){let i=e.$implicit;c("value",i.id),o(),m(" ",i.methodName," ")}}function re(d,e){if(d&1&&(t(0,"option",44),a(1),r()),d&2){let i=e.$implicit;c("value",i.id),o(),T(" ",i.firstName," ",i.lastName," ")}}var J=class d{constructor(e,i,n,l,s){this.router=e;this.authService=i;this.cashService=n;this.productService=l;this.saleService=s}currentUser=null;currentSession=null;products=[];filteredProducts=[];searchTerm="";loadingProducts=!0;saleItems=[];taxRate=19;paymentMethods=[];customers=[];selectedPaymentMethod=null;selectedCustomerId=null;saleObservations="";showPaymentModal=!1;showSuccessModal=!1;lastSaleTotal=0;ngOnInit(){this.currentUser=this.authService.currentUserValue,this.cashService.currentSession$.subscribe(e=>{this.currentSession=e}),this.loadProducts(),this.loadPaymentMethods(),this.loadCustomers()}loadProducts(){this.loadingProducts=!0,this.productService.getAll().subscribe({next:e=>{this.products=e.filter(i=>i.state),this.filteredProducts=this.products,this.loadingProducts=!1},error:e=>{console.error("Error loading products:",e),this.loadingProducts=!1}})}loadPaymentMethods(){this.saleService.getPaymentMethods().subscribe({next:e=>{this.paymentMethods=e.filter(i=>i.state)},error:e=>{console.error("Error loading payment methods:",e)}})}loadCustomers(){this.saleService.getCustomers().subscribe({next:e=>{this.customers=e.filter(i=>i.state)},error:e=>{console.error("Error loading customers:",e)}})}filterProducts(){let e=this.searchTerm.toLowerCase().trim();if(!e){this.filteredProducts=this.products;return}this.filteredProducts=this.products.filter(i=>i.name.toLowerCase().includes(e)||i.code?.toLowerCase().includes(e)||i.categoryName?.toLowerCase().includes(e))}addProductToSale(e){if(e.stockQuantity<=0){alert("Este producto no tiene stock disponible");return}let i=this.saleItems.find(n=>n.productId===e.id);if(i)i.quantity<e.stockQuantity?(i.quantity++,i.subtotal=i.quantity*i.unitPrice):alert(`Stock m\xE1ximo alcanzado (${e.stockQuantity} unidades)`);else{let n={productId:e.id,productName:e.name,quantity:1,unitPrice:e.salePrice,subtotal:e.salePrice,availableStock:e.stockQuantity};this.saleItems.push(n)}}removeFromSale(e){let i=this.saleItems.indexOf(e);i>-1&&this.saleItems.splice(i,1)}increaseQuantity(e){e.quantity<e.availableStock?(e.quantity++,e.subtotal=e.quantity*e.unitPrice):alert(`Stock m\xE1ximo alcanzado (${e.availableStock} unidades)`)}decreaseQuantity(e){e.quantity>1?(e.quantity--,e.subtotal=e.quantity*e.unitPrice):this.removeFromSale(e)}calculateSubtotal(){return this.saleItems.reduce((e,i)=>e+i.subtotal,0)}calculateTax(){return this.calculateSubtotal()*(this.taxRate/100)}calculateTotal(){return this.calculateSubtotal()+this.calculateTax()}clearSale(){confirm("\xBFEst\xE1s seguro de que deseas limpiar el carrito?")&&(this.saleItems=[])}openPaymentModal(){if(!this.currentSession){alert("Debes abrir una sesi\xF3n de caja antes de realizar ventas");return}this.showPaymentModal=!0}completeSale(){if(!this.selectedPaymentMethod){alert("Debes seleccionar un m\xE9todo de pago");return}if(!this.currentSession){alert("No hay una sesi\xF3n de caja abierta");return}let e={cashSessionId:this.currentSession.id,customerId:this.selectedCustomerId,saleDate:new Date().toISOString(),totalAmount:this.calculateTotal(),taxAmount:this.calculateTax(),observations:this.saleObservations||null,status:"Pendiente",state:!0};this.saleService.create(e).subscribe({next:i=>{let n=this.saleItems.map(l=>{let s={saleId:i.id,productId:l.productId,quantity:l.quantity,unitPrice:l.unitPrice,subtotal:l.subtotal,state:!0};return this.saleService.addProduct(s).toPromise()});Promise.all(n).then(()=>{this.saleService.finalizeSale(i.id).subscribe({next:()=>{this.lastSaleTotal=this.calculateTotal(),this.showPaymentModal=!1,this.showSuccessModal=!0,this.saleItems=[],this.selectedPaymentMethod=null,this.selectedCustomerId=null,this.saleObservations="",this.loadProducts()},error:l=>{console.error("Error finalizing sale:",l),alert("Error al finalizar la venta: "+(l.error?.message||"Error desconocido"))}})})},error:i=>{console.error("Error creating sale:",i),alert("Error al crear la venta: "+(i.error?.message||"Error desconocido"))}})}closeSuccessModal(){this.showSuccessModal=!1}goBack(){this.router.navigate(["/dashboard"])}static \u0275fac=function(i){return new(i||d)(x(N),x(A),x(F),x(U),x(R))};static \u0275cmp=I({type:d,selectors:[["app-pos"]],decls:96,vars:50,consts:[[1,"h-screen","bg-bg-green","flex","flex-col","overflow-hidden"],[1,"bg-white","border-b","border-border-green","px-6","py-4","flex","items-center","justify-between"],[1,"flex","items-center","gap-4"],[1,"text-gray-600","hover:text-estanco","transition-colors",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M10 19l-7-7m0 0l7-7m-7 7h18"],[1,"text-2xl","font-bold","text-estanco-dark"],[1,"text-sm","text-gray-600"],[1,"font-medium"],["class","bg-success/10 text-success px-4 py-2 rounded-md text-sm font-medium",4,"ngIf"],["class","bg-error/10 text-error px-4 py-2 rounded-md text-sm font-medium",4,"ngIf"],[1,"flex-1","flex","overflow-hidden"],[1,"flex-1","flex","flex-col","bg-white","border-r","border-border-green"],[1,"p-4","border-b","border-border-green"],[1,"relative"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"absolute","left-3","top-1/2","-translate-y-1/2","w-5","h-5","text-gray-400"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"],["type","text","placeholder","Buscar producto por nombre, c\xF3digo o categor\xEDa...",1,"w-full","pl-10","pr-4","py-3","border-2","border-border-green","rounded-lg","focus:border-lime","focus:ring-4","focus:ring-lime/10","transition-all",3,"ngModelChange","input","ngModel"],[1,"flex-1","overflow-y-auto","p-4"],["class","flex justify-center items-center h-full",4,"ngIf"],["class","flex flex-col items-center justify-center h-full text-gray-400",4,"ngIf"],[1,"grid","grid-cols-2","md:grid-cols-3","lg:grid-cols-4","gap-3"],["class","bg-white border-2 border-border-green rounded-lg p-4 hover:border-lime hover:shadow-green-md transition-all cursor-pointer",3,"opacity-50","cursor-not-allowed","click",4,"ngFor","ngForOf"],[1,"w-96","flex","flex-col","bg-bg-green"],[1,"bg-estanco","text-white","px-6","py-4"],[1,"text-xl","font-bold"],[1,"text-sm","text-mint"],[1,"flex-1","overflow-y-auto","p-4","space-y-2"],["class","bg-white border border-border-green rounded-lg p-3",4,"ngFor","ngForOf"],[1,"bg-white","border-t-2","border-border-green","p-6","space-y-3"],[1,"flex","justify-between","text-gray-600"],[1,"font-semibold"],[1,"border-t-2","border-border-green","pt-3","flex","justify-between","text-2xl","font-bold"],[1,"text-estanco-dark"],[1,"text-lime"],[1,"flex","gap-2","pt-4"],[1,"flex-1","btn-secondary",3,"click","disabled"],[1,"flex-1","btn-primary",3,"click","disabled"],[3,"confirmed","closed","isOpen","title","type","confirmText","showCancelButton","cancelText"],[1,"space-y-4"],[1,"bg-lime/10","border","border-lime","rounded-lg","p-4"],[1,"text-3xl","font-bold","text-lime"],[1,"label"],[1,"input",3,"ngModelChange","ngModel"],[3,"value"],[3,"value",4,"ngFor","ngForOf"],["rows","2","placeholder","Notas adicionales sobre la venta...",1,"input",3,"ngModelChange","ngModel"],[3,"closed","isOpen","title","type","confirmText"],[1,"text-center","py-4"],[1,"w-16","h-16","bg-success/10","rounded-full","mx-auto","mb-4","flex","items-center","justify-center"],["fill","currentColor","viewBox","0 0 20 20",1,"w-10","h-10","text-success"],["fill-rule","evenodd","d","M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z","clip-rule","evenodd"],[1,"text-lg","font-semibold","text-gray-800","mb-2"],[1,"bg-success/10","text-success","px-4","py-2","rounded-md","text-sm","font-medium"],[1,"bg-error/10","text-error","px-4","py-2","rounded-md","text-sm","font-medium"],[1,"flex","justify-center","items-center","h-full"],[1,"animate-spin","rounded-full","h-12","w-12","border-b-2","border-estanco"],[1,"flex","flex-col","items-center","justify-center","h-full","text-gray-400"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-16","h-16","mb-4"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"],[1,"text-lg","font-medium"],[1,"bg-white","border-2","border-border-green","rounded-lg","p-4","hover:border-lime","hover:shadow-green-md","transition-all","cursor-pointer",3,"click"],[1,"text-3xl","mb-2","text-center"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-12","h-12","mx-auto","text-estanco"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"],[1,"font-semibold","text-sm","text-estanco-dark","mb-1","truncate"],[1,"text-xs","text-gray-500","mb-2"],[1,"flex","justify-between","items-center"],[1,"text-lg","font-bold","text-lime"],[1,"text-xs","px-2","py-1","rounded",3,"ngClass"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"],[1,"text-sm"],[1,"bg-white","border","border-border-green","rounded-lg","p-3"],[1,"flex","justify-between","items-start","mb-2"],[1,"flex-1"],[1,"font-semibold","text-sm","text-estanco-dark"],[1,"text-xs","text-gray-500"],[1,"text-error","hover:bg-error/10","p-1","rounded","transition-colors",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"],[1,"flex","items-center","justify-between"],[1,"flex","items-center","gap-2"],[1,"bg-gray-200","hover:bg-gray-300","w-8","h-8","rounded","flex","items-center","justify-center","transition-colors",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-4","h-4"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M20 12H4"],[1,"w-12","text-center","font-semibold"],[1,"bg-lime","hover:bg-lime-light","text-white","w-8","h-8","rounded","flex","items-center","justify-center","transition-colors",3,"click"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 4v16m8-8H4"],[1,"text-right"],[1,"font-bold","text-lg","text-estanco"]],template:function(i,n){i&1&&(t(0,"div",0)(1,"div",1)(2,"div",2)(3,"button",3),p("click",function(){return n.goBack()}),v(),t(4,"svg",4),u(5,"path",5),r()(),f(),t(6,"h1",6),a(7,"Punto de Venta"),r()(),t(8,"div",2)(9,"div",7)(10,"span",8),a(11,"Cajero:"),r(),a(12),r(),b(13,K,3,4,"div",9)(14,X,2,0,"div",10),r()(),t(15,"div",11)(16,"div",12)(17,"div",13)(18,"div",14),v(),t(19,"svg",15),u(20,"path",16),r(),f(),t(21,"input",17),M("ngModelChange",function(s){return C(n.searchTerm,s)||(n.searchTerm=s),s}),p("input",function(){return n.filterProducts()}),r()()(),t(22,"div",18),b(23,Y,2,0,"div",19)(24,Z,5,0,"div",20),t(25,"div",21),b(26,ee,14,12,"div",22),r()()(),t(27,"div",23)(28,"div",24)(29,"h2",25),a(30,"Carrito de Venta"),r(),t(31,"p",26),a(32),r()(),t(33,"div",27),b(34,te,5,0,"div",20)(35,ie,25,10,"div",28),r(),t(36,"div",29)(37,"div",30)(38,"span"),a(39,"Subtotal:"),r(),t(40,"span",31),a(41),h(42,"number"),r()(),t(43,"div",30)(44,"span"),a(45),r(),t(46,"span",31),a(47),h(48,"number"),r()(),t(49,"div",32)(50,"span",33),a(51,"Total:"),r(),t(52,"span",34),a(53),h(54,"number"),r()(),t(55,"div",35)(56,"button",36),p("click",function(){return n.clearSale()}),a(57," Limpiar "),r(),t(58,"button",37),p("click",function(){return n.openPaymentModal()}),a(59," Cobrar "),r()()()()()(),t(60,"app-modal",38),p("confirmed",function(){return n.completeSale()})("closed",function(){return n.showPaymentModal=!1}),t(61,"div",39)(62,"div",40)(63,"p",7),a(64,"Total a pagar:"),r(),t(65,"p",41),a(66),h(67,"number"),r()(),t(68,"div")(69,"label",42),a(70,"M\xE9todo de Pago"),r(),t(71,"select",43),M("ngModelChange",function(s){return C(n.selectedPaymentMethod,s)||(n.selectedPaymentMethod=s),s}),t(72,"option",44),a(73,"Seleccionar m\xE9todo"),r(),b(74,ne,2,2,"option",45),r()(),t(75,"div")(76,"label",42),a(77,"Cliente (Opcional)"),r(),t(78,"select",43),M("ngModelChange",function(s){return C(n.selectedCustomerId,s)||(n.selectedCustomerId=s),s}),t(79,"option",44),a(80,"Cliente general"),r(),b(81,re,2,3,"option",45),r()(),t(82,"div")(83,"label",42),a(84,"Observaciones (Opcional)"),r(),t(85,"textarea",46),M("ngModelChange",function(s){return C(n.saleObservations,s)||(n.saleObservations=s),s}),r()()()(),t(86,"app-modal",47),p("closed",function(){return n.closeSuccessModal()}),t(87,"div",48)(88,"div",49),v(),t(89,"svg",50),u(90,"path",51),r()(),f(),t(91,"p",52),a(92,"La venta se ha procesado correctamente"),r(),t(93,"p",41),a(94),h(95,"number"),r()()()),i&2&&(o(12),m(" ",n.currentUser==null?null:n.currentUser.email," "),o(),c("ngIf",n.currentSession),o(),c("ngIf",!n.currentSession),o(7),w("ngModel",n.searchTerm),o(2),c("ngIf",n.loadingProducts),o(),c("ngIf",!n.loadingProducts&&n.filteredProducts.length===0),o(2),c("ngForOf",n.filteredProducts),o(6),m("",n.saleItems.length," productos"),o(2),c("ngIf",n.saleItems.length===0),o(),c("ngForOf",n.saleItems),o(6),m("$",g(42,35,n.calculateSubtotal(),"1.0-0")),o(4),m("IVA (",n.taxRate,"%):"),o(2),m("$",g(48,38,n.calculateTax(),"1.0-0")),o(6),m("$",g(54,41,n.calculateTotal(),"1.0-0")),o(3),c("disabled",n.saleItems.length===0),o(2),c("disabled",n.saleItems.length===0||!n.currentSession),o(2),c("isOpen",n.showPaymentModal)("title","Procesar Pago")("type","info")("confirmText","Completar Venta")("showCancelButton",!0)("cancelText","Cancelar"),o(6),m("$",g(67,44,n.calculateTotal(),"1.0-0")),o(5),w("ngModel",n.selectedPaymentMethod),o(),c("value",null),o(2),c("ngForOf",n.paymentMethods),o(4),w("ngModel",n.selectedCustomerId),o(),c("value",null),o(2),c("ngForOf",n.customers),o(4),w("ngModel",n.saleObservations),o(),c("isOpen",n.showSuccessModal)("title","\xA1Venta Exitosa!")("type","success")("confirmText","Aceptar"),o(8),m("$",g(95,47,n.lastSaleTotal,"1.0-0")))},dependencies:[L,j,O,V,z,W,$,H,Q,q,D,G,B],styles:["[_nghost-%COMP%]{display:block;height:100%}"]})};export{J as PosComponent};
