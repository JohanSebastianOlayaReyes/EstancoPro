<div class="users-page">

  <div class="users-body">
    <div class="side-column">
      <app-sidebar-menu [sections]="menuSections"></app-sidebar-menu>
    </div>
    <div class="list-column">
      <div class="users-header">
        <div class="section-title">
          <h1>Gestión de Usuarios</h1>
        </div>

        <div class="users-actions">
          <div class="filters">
            <input type="text" class="filter-input" placeholder="Buscar por nombre de usuario" (input)="onFilterName($any($event.target).value)" />
            <select class="filter-select" (change)="onFilterRole($any($event.target).value)">
              <option value="0">Todos los roles</option>
              <option *ngFor="let r of roles()" [value]="r.id">{{ r.typeRol }}</option>
            </select>
              <label class="filter-checkbox">
                <input type="checkbox" [checked]="showInactive()" (change)="showInactive.set($any($event.target).checked); loadUsers();" /> Mostrar inactivos
              </label>
          </div>
          <app-button variant="primary" (clicked)="openCreate()">+ Nuevo Usuario</app-button>
        </div>
      </div>
      <!-- Modal form: shown as modal overlay when showForm() is true -->
      <div *ngIf="showForm()" class="modal-overlay">
        <div class="modal-window">
          <div class="modal-header">
            <h3>{{ editingUserId() ? 'Editar Usuario' : 'Crear Usuario' }}</h3>
            <button class="close-btn" (click)="cancelForm()">✕</button>
          </div>
          <form (submit)="saveUser($event)" class="compact-form">
            <app-input id="username" label="Nombre" placeholder="Juan Pérez" [value]="form().username" (valueChange)="updateForm('username', $event)" [required]="true"></app-input>
            <app-input id="email" type="email" label="Email" placeholder="juan@test.com" [value]="form().email" (valueChange)="updateForm('email', $event)" [required]="true"></app-input>
            <app-input id="password" type="password" label="Contraseña" placeholder="••••••" [value]="form().password" (valueChange)="updateForm('password', $event)" [required]="!editingUserId()"></app-input>
            <div class="form-group">
              <label>Rol</label>
              <select [value]="form().rolId" (change)="onRolChange($event)" class="form-select">
                <option value="0">Selecciona rol</option>
                <option *ngFor="let r of roles()" [value]="r.id">{{ r.typeRol }}</option>
              </select>
            </div>
            <div class="form-actions">
              <app-button type="button" variant="ghost" (clicked)="cancelForm()">Cancelar</app-button>
              <app-button type="submit" variant="primary" [loading]="loading()">{{ editingUserId() ? 'Actualizar' : 'Crear' }}</app-button>
            </div>
          </form>
        </div>
        <div class="modal-backdrop" (click)="cancelForm()"></div>
      </div>

      <div *ngIf="error()" class="alert error">{{ error() }}</div>
      <div *ngIf="success()" class="alert success">{{ success() }}</div>

      <div class="users-grid">
        <p *ngIf="filteredUsers().length === 0" class="empty-state">No hay usuarios que coincidan.</p>
        <ng-container *ngFor="let user of filteredUsers(); let i = index">
          <app-estanco-card class="user-item">
            <div class="user-header">
              <h4>{{ user.username }}</h4>
              <span class="badge" [class.active]="user.active">{{ user.active ? 'Activo' : 'Inactivo' }}</span>
            </div>
            <p class="user-email">{{ user.email }}</p>
            <p class="user-rol">Rol: {{ getUserRoleName(user) }}</p>
            <div class="user-actions">
              <app-button variant="ghost" size="sm" (clicked)="startEdit(user)">Editar</app-button>
              <app-button *ngIf="user.active" variant="destructive" size="sm" (clicked)="deleteUser(user.id)">Desactivar</app-button>
              <app-button *ngIf="!user.active" variant="primary" size="sm" (clicked)="activateUser(user.id)">Activar</app-button>
            </div>
          </app-estanco-card>
        </ng-container>
      </div>
    </div>

    
  </div>
</div>
