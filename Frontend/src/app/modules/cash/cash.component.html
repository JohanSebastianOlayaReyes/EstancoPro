<div class="min-h-screen bg-bg-green p-6">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <button (click)="goBack()" class="text-gray-600 hover:text-estanco transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
        </button>
        <div>
          <h1 class="text-3xl font-bold text-estanco-dark">Gestión de Caja</h1>
          <p class="text-gray-600 mt-1">Control de sesiones de caja y movimientos</p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div *ngIf="currentSession" class="bg-success/10 border border-success text-success px-4 py-2 rounded-lg">
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span class="font-semibold">Caja Abierta</span>
          </div>
        </div>

        <button
          *ngIf="!currentSession"
          (click)="openOpenSessionModal()"
          class="btn-primary flex items-center gap-2"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Abrir Caja
        </button>

        <button
          *ngIf="currentSession"
          (click)="openCloseSessionModal()"
          class="btn-danger flex items-center gap-2"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
          Cerrar Caja
        </button>
      </div>
    </div>

    <!-- Current Session Info -->
    <div *ngIf="currentSession" class="card mb-6 bg-gradient-to-br from-estanco to-estanco-dark text-white">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-xl font-bold mb-2">Sesión Actual</h3>
          <p class="text-mint text-sm">Apertura: {{ currentSession.openedAt | date:'dd/MM/yyyy HH:mm' }}</p>
        </div>
        <div class="text-right">
          <p class="text-mint text-sm mb-1">Monto Inicial</p>
          <p class="text-3xl font-bold">${{ currentSession.openingAmount | number:'1.0-0' }}</p>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="flex justify-center items-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-estanco"></div>
    </div>

    <!-- Sessions List -->
    <div *ngIf="!loading" class="space-y-4">
      <h2 class="text-2xl font-bold text-estanco-dark mb-4">Historial de Sesiones</h2>

      <div *ngIf="sessions.length === 0" class="card text-center py-12">
        <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
        </svg>
        <p class="text-lg font-medium text-gray-600">No hay sesiones registradas</p>
        <p class="text-sm text-gray-500 mt-2">Abre una nueva sesión de caja para comenzar</p>
      </div>

      <div *ngFor="let session of sessions" class="card hover:shadow-green-md transition-all cursor-pointer" (click)="viewSessionDetails(session)">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="flex items-center gap-3 mb-2">
              <span class="px-3 py-1 rounded-full text-sm font-medium" [ngClass]="getSessionStatusClass(session)">
                {{ getSessionStatus(session) }}
              </span>
              <span class="text-sm text-gray-600">{{ session.openedAt | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-6 text-right">
            <div>
              <p class="text-xs text-gray-600 mb-1">Apertura</p>
              <p class="text-lg font-bold text-success">${{ session.openingAmount | number:'1.0-0' }}</p>
            </div>
            <div *ngIf="session.closedAt">
              <p class="text-xs text-gray-600 mb-1">Cierre</p>
              <p class="text-lg font-bold text-error">${{ session.closingAmount | number:'1.0-0' }}</p>
            </div>
          </div>

          <svg class="w-6 h-6 text-gray-400 ml-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Open Session Modal -->
<app-modal
  [isOpen]="showOpenModal"
  [title]="'Abrir Sesión de Caja'"
  [type]="'info'"
  [confirmText]="processingAction ? 'Abriendo...' : 'Abrir Caja'"
  [showCancelButton]="true"
  [cancelText]="'Cancelar'"
  (confirmed)="openSession()"
  (closed)="showOpenModal = false"
>
  <div class="space-y-4">
    <div>
      <label class="label">Monto Inicial *</label>
      <div class="relative">
        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
        <input
          type="number"
          [(ngModel)]="openingAmount"
          [disabled]="processingAction"
          min="0"
          step="1000"
          class="input pl-8"
          placeholder="0"
        />
      </div>
      <p class="text-xs text-gray-500 mt-1">Monto con el que se abre la caja</p>
    </div>

  </div>
</app-modal>

<!-- Close Session Modal -->
<app-modal
  [isOpen]="showCloseModal"
  [title]="'Cerrar Sesión de Caja'"
  [type]="'warning'"
  [confirmText]="processingAction ? 'Cerrando...' : 'Cerrar Caja'"
  [showCancelButton]="true"
  [cancelText]="'Cancelar'"
  (confirmed)="closeSession()"
  (closed)="showCloseModal = false"
>
  <div class="space-y-4">
    <!-- Summary -->
    <div class="bg-gray-50 rounded-lg p-4 space-y-2">
      <div class="flex justify-between text-sm">
        <span class="text-gray-600">Monto Inicial:</span>
        <span class="font-semibold">${{ currentSession?.openingAmount | number:'1.0-0' }}</span>
      </div>
      <div class="flex justify-between text-sm">
        <span class="text-gray-600">Ventas del Día:</span>
        <span class="font-semibold text-success">${{ calculateTotalSales() | number:'1.0-0' }}</span>
      </div>
      <div class="border-t border-gray-200 pt-2 flex justify-between">
        <span class="font-semibold">Efectivo Esperado:</span>
        <span class="text-lg font-bold text-estanco">${{ calculateExpectedClosing() | number:'1.0-0' }}</span>
      </div>
    </div>

    <div>
      <label class="label">Efectivo en Caja *</label>
      <div class="relative">
        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
        <input
          type="number"
          [(ngModel)]="closingAmount"
          [disabled]="processingAction"
          min="0"
          step="1000"
          class="input pl-8"
          placeholder="0"
          (input)="calculateDifference()"
        />
      </div>
    </div>

    <!-- Difference Alert -->
    <div *ngIf="closingAmount > 0" class="p-3 rounded-lg" [ngClass]="{
      'bg-success/10 border border-success text-success': calculateDifference() === 0,
      'bg-warning/10 border border-warning text-warning': calculateDifference() !== 0
    }">
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
        </svg>
        <span class="font-semibold">
          {{ calculateDifference() === 0 ? 'Cuadre perfecto' :
             calculateDifference() > 0 ? 'Sobrante: $' + (calculateDifference() | number:'1.0-0') :
             'Faltante: $' + (Math.abs(calculateDifference()) | number:'1.0-0') }}
        </span>
      </div>
    </div>

  </div>
</app-modal>

<!-- Session Details Modal -->
<app-modal
  [isOpen]="showDetailsModal"
  [title]="'Detalles de Sesión'"
  [type]="'info'"
  [confirmText]="'Cerrar'"
  (closed)="showDetailsModal = false"
>
  <div *ngIf="selectedSession" class="space-y-4">
    <div class="grid grid-cols-2 gap-4">
      <div>
        <p class="text-xs text-gray-600 mb-1">Estado</p>
        <span class="px-3 py-1 rounded-full text-sm font-medium" [ngClass]="getSessionStatusClass(selectedSession)">
          {{ getSessionStatus(selectedSession) }}
        </span>
      </div>
      <div>
        <p class="text-xs text-gray-600 mb-1">Usuario</p>
        <p class="font-semibold">{{ currentUser?.email }}</p>
      </div>
    </div>

    <div class="border-t border-gray-200 pt-4">
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <p class="text-xs text-gray-600 mb-1">Fecha Apertura</p>
          <p class="font-semibold">{{ selectedSession.openedAt | date:'dd/MM/yyyy HH:mm' }}</p>
        </div>
        <div *ngIf="selectedSession.closedAt">
          <p class="text-xs text-gray-600 mb-1">Fecha Cierre</p>
          <p class="font-semibold">{{ selectedSession.closedAt | date:'dd/MM/yyyy HH:mm' }}</p>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <p class="text-xs text-gray-600 mb-1">Monto Apertura</p>
          <p class="text-xl font-bold text-success">${{ selectedSession.openingAmount | number:'1.0-0' }}</p>
        </div>
        <div *ngIf="selectedSession.closedAt">
          <p class="text-xs text-gray-600 mb-1">Monto Cierre</p>
          <p class="text-xl font-bold text-error">${{ selectedSession.closingAmount | number:'1.0-0' }}</p>
        </div>
      </div>
    </div>


    <div class="border-t border-gray-200 pt-4">
      <h4 class="font-semibold mb-3">Ventas de la Sesión</h4>
      <div *ngIf="loadingSales" class="flex justify-center py-4">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-estanco"></div>
      </div>
      <div *ngIf="!loadingSales && sessionSales.length === 0" class="text-center py-4 text-gray-500">
        No hay ventas registradas
      </div>
      <div *ngIf="!loadingSales && sessionSales.length > 0" class="space-y-2">
        <div *ngFor="let sale of sessionSales" class="flex justify-between items-center py-2 border-b border-gray-100">
          <div>
            <p class="text-sm font-medium">Venta #{{ sale.id }}</p>
            <p class="text-xs text-gray-500">{{ sale.saleDate | date:'HH:mm' }}</p>
          </div>
          <p class="font-bold text-lime">${{ sale.totalAmount | number:'1.0-0' }}</p>
        </div>
        <div class="pt-2 flex justify-between items-center">
          <span class="font-semibold">Total Ventas:</span>
          <span class="text-xl font-bold text-lime">${{ calculateTotalSales() | number:'1.0-0' }}</span>
        </div>
      </div>
    </div>
  </div>
</app-modal>

<!-- Success Modal -->
<app-modal
  [isOpen]="showSuccessModal"
  [title]="'Operación Exitosa'"
  [type]="'success'"
  [confirmText]="'Aceptar'"
  (closed)="showSuccessModal = false; loadSessions()"
>
  <div class="text-center py-4">
    <div class="w-16 h-16 bg-success/10 rounded-full mx-auto mb-4 flex items-center justify-center">
      <svg class="w-10 h-10 text-success" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
      </svg>
    </div>
    <p class="text-lg font-semibold text-gray-800">{{ successMessage }}</p>
  </div>
</app-modal>
